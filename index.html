<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>网站服务器下载测试</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .control-panel {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      align-items: center;
    }
    .control-panel input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .control-panel button {
      padding: 8px 15px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .control-panel button:hover {
      background-color: #45a049;
    }
    .control-panel button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .stats-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .stat-box {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
      background-color: #f9f9f9;
    }
    .stat-title {
      font-size: 14px;
      color: #666;
      margin-bottom: 5px;
    }
    .stat-value {
      font-size: 24px;
      font-weight: bold;
    }
    .stat-unit {
      font-size: 14px;
      color: #666;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      padding: 8px 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background-color: #f2f2f2;
    }
    .status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
      display: none;
    }
    .error {
      background-color: #ffebee;
      color: #c62828;
    }
    .success {
      background-color: #e8f5e9;
      color: #2e7d32;
    }
    .chart-container {
      width: 100%;
      height: 300px;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <h1>网站服务器下载测试</h1>

  <div class="control-panel">
    <input type="text" id="downloadUrl" placeholder="请输入下载URL (http://example.com/large-file.zip)" value="https://speed.cloudflare.com/10mb">
    <button id="startBtn">开始测试</button>
    <button id="stopBtn" disabled>停止测试</button>
  </div>

  <div id="statusMessage" class="status"></div>

  <div class="stats-panel">
    <div class="stat-box">
      <div class="stat-title">累计流量</div>
      <div class="stat-value" id="totalGB">0</div>
      <div class="stat-unit">GB</div>
    </div>
    <div class="stat-box">
      <div class="stat-title">当前网速</div>
      <div class="stat-value" id="lastSpeedMbps">0</div>
      <div class="stat-unit">Mb/s</div>
    </div>
    <div class="stat-box">
      <div class="stat-title">目标 IP</div>
      <div class="stat-value" id="targetIP">-</div>
    </div>
    <div class="stat-box">
      <div class="stat-title">已运行时间</div>
      <div class="stat-value" id="duration">0</div>
      <div class="stat-unit">秒</div>
    </div>
  </div>

  <h2>流量实时图表（网速 Mb/s）</h2>
  <div class="chart-container">
    <canvas id="speedChart"></canvas>
  </div>

  <h2>任务记录</h2>
  <table>
    <thead>
      <tr>
        <th>开始时间</th>
        <th>结束时间</th>
        <th>时长 (秒)</th>
        <th>累计流量 (GB)</th>
        <th>平均网速 (Mb/s)</th>
      </tr>
    </thead>
    <tbody id="recordsTable">
      <!-- 任务记录将在这里动态添加 -->
    </tbody>
  </table>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // DOM 元素
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const downloadUrlInput = document.getElementById('downloadUrl');
    const totalGBElement = document.getElementById('totalGB');
    const lastSpeedMbpsElement = document.getElementById('lastSpeedMbps');
    const targetIPElement = document.getElementById('targetIP');
    const durationElement = document.getElementById('duration');
    const recordsTableElement = document.getElementById('recordsTable');
    const statusMessageElement = document.getElementById('statusMessage');
    
    // 图表初始化
    const ctx = document.getElementById('speedChart').getContext('2d');
    const speedChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: '下载速度 (Mb/s)',
          data: [],
          borderColor: 'rgb(75, 192, 192)',
          tension: 0.1,
          fill: false
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: {
            display: true,
            title: {
              display: true,
              text: '时间 (秒)'
            }
          },
          y: {
            display: true,
            title: {
              display: true,
              text: '速度 (Mb/s)'
            },
            suggestedMin: 0
          }
        }
      }
    });
    
    // 状态变量
    let isRunning = false;
    const speedData = [];
    const timeLabels = [];
    
    // 连接到Socket.io服务器
    let socket;
    try {
      socket = io();
      console.log("Socket.io 连接已建立");
      
      socket.on('connect', () => {
        console.log('已连接到服务器');
        showStatus('已连接到服务器', 'success');
      });
      
      socket.on('connect_error', (error) => {
        console.error('连接错误:', error);
        showStatus('连接到服务器失败，请刷新页面重试', 'error');
      });
      
      socket.on('stats', (data) => {
        // 更新界面统计数据
        totalGBElement.textContent = data.totalGB;
        lastSpeedMbpsElement.textContent = data.lastSpeedMbps;
        targetIPElement.textContent = data.ip || '-';
        durationElement.textContent = data.duration;
        
        // 更新图表
        timeLabels.push(data.duration);
        speedData.push(parseFloat(data.lastSpeedMbps));
        
        // 限制图表点数量，保持最新的30个数据点
        if (timeLabels.length > 30) {
          timeLabels.shift();
          speedData.shift();
        }
        
        speedChart.data.labels = timeLabels;
        speedChart.data.datasets[0].data = speedData;
        speedChart.update();
      });
    } catch (err) {
      console.error('创建Socket.io连接失败:', err);
      showStatus('创建Socket.io连接失败，请刷新页面重试', 'error');
    }
    
    // 开始测试按钮点击事件
    startBtn.addEventListener('click', async () => {
      const url = downloadUrlInput.value.trim();
      
      if (!url) {
        showStatus('请输入有效的下载URL', 'error');
        return;
      }
      
      try {
        startBtn.disabled = true;
        stopBtn.disabled = false;
        isRunning = true;
        
        // 重置图表数据
        timeLabels.length = 0;
        speedData.length = 0;
        speedChart.data.labels = [];
        speedChart.data.datasets[0].data = [];
        speedChart.update();
        
        showStatus('正在启动测试...', 'success');
        
        const response = await fetch('/start', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ url })
        });
        
        if (!response.ok) {
          throw new Error(`服务器响应错误: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('测试开始:', result);
        showStatus(`测试已开始，使用 ${result.threads} 个线程`, 'success');
      } catch (err) {
        console.error('启动测试失败:', err);
        showStatus(`启动测试失败: ${err.message}`, 'error');
        startBtn.disabled = false;
        stopBtn.disabled = true;
        isRunning = false;
      }
    });
    
    // 停止测试按钮点击事件
    stopBtn.addEventListener('click', async () => {
      try {
        startBtn.disabled = false;
        stopBtn.disabled = true;
        isRunning = false;
        
        showStatus('正在停止测试...', 'success');
        
        const response = await fetch('/stop', {
          method: 'POST'
        });
        
        if (!response.ok) {
          throw new Error(`服务器响应错误: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('测试停止:', result);
        showStatus('测试已停止', 'success');
        
        // 添加新的记录到表格
        if (result.record) {
          addRecordToTable(result.record);
        }
        
        // 重新加载所有记录
        loadRecords();
      } catch (err) {
        console.error('停止测试失败:', err);
        showStatus(`停止测试失败: ${err.message}`, 'error');
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }
    });
    
    // 添加记录到表格
    function addRecordToTable(record) {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${record.startTime}</td>
        <td>${record.endTime}</td>
        <td>${record.durationSec}</td>
        <td>${record.totalGB}</td>
        <td>${record.averageSpeedMbps}</td>
      `;
      recordsTableElement.appendChild(row);
    }
    
    // 加载所有记录
    async function loadRecords() {
      try {
        const response = await fetch('/records');
        if (!response.ok) {
          throw new Error(`服务器响应错误: ${response.status}`);
        }
        
        const records = await response.json();
        console.log('加载记录:', records);
        
        // 清空表格
        recordsTableElement.innerHTML = '';
        
        // 添加所有记录
        records.forEach(record => {
          addRecordToTable(record);
        });
      } catch (err) {
        console.error('加载记录失败:', err);
        showStatus(`加载记录失败: ${err.message}`, 'error');
      }
    }
    
    // 显示状态消息
    function showStatus(message, type) {
      statusMessageElement.textContent = message;
      statusMessageElement.className = `status ${type}`;
      statusMessageElement.style.display = 'block';
      
      // 5秒后隐藏成功消息
      if (type === 'success') {
        setTimeout(() => {
          statusMessageElement.style.display = 'none';
        }, 5000);
      }
    }
    
    // 页面加载时获取记录
    window.addEventListener('load', () => {
      loadRecords();
    });
    
    // 在页面关闭时停止测试
    window.addEventListener('beforeunload', async (event) => {
      if (isRunning) {
        try {
          await fetch('/stop', { method: 'POST' });
        } catch (err) {
          console.error('关闭页面前停止测试失败:', err);
        }
      }
    });
  </script>
</body>
</html>